# Правила разработки на платформе 1С:Предприятие с Claude Code

## Обзор

Данный документ определяет единые стандарты и методологию разработки расширений и конфигураций 1С:Предприятие 8 с использованием AI-ассистента Claude Code. Правила основаны на анализе лучших практик из реальных проектов и адаптированы для различных сценариев разработки.

## Поддерживаемые версии платформы

| Компонент | Минимальная версия | Рекомендуемая |
|-----------|-------------------|---------------|
| 1C:Enterprise Platform | 8.3.21+ | 8.3.25+ |
| БСП (SSL) | 3.1.6+ | 3.1.10+ |

### Возможности по версиям

- **8.3.21+**: Поддержка JWT (ТокенДоступа)
- **8.3.25+**: Улучшенная работа с HTTP
- **8.3.27+**: Async операции, фоновые задания нового типа

---

## Принципы поведения Claude Code

### Классификация запросов

| Тип | Описание | Действие |
|-----|----------|----------|
| **Trivial** | Однострочные исправления, очевидные баги | Выполнить сразу |
| **Explicit** | Четкие инструкции с конкретным результатом | Выполнить по инструкции |
| **Exploratory** | Исследование кодовой базы, поиск | Использовать агентов исследования |
| **Open-ended** | Архитектурные задачи, новый функционал | Полный workflow с планированием |
| **Ambiguous** | Неясные требования | Уточнить перед выполнением |

### Стиль коммуникации

- **Без преамбул** - сразу к делу
- **Без лести** - объективная оценка
- **Технически точно** - факты важнее эмоций
- **Прямо и кратко** - экономия токенов и времени

### Протокол восстановления после ошибок

**Правило трёх ошибок**: После 3 последовательных неудачных попыток — СТОП.

1. Остановиться и проанализировать паттерн ошибок
2. Сообщить пользователю о проблеме
3. Предложить альтернативный подход или запросить помощь

### Стандарты качества кода

- Соответствие существующим паттернам проекта
- Никакого подавления ошибок (`Попытка...Исключение` только где необходимо)
- Минимальные изменения — без scope creep
- Код должен быть самодокументируемым

---

## Методология разработки

### Базовый workflow

```
Explore → Plan → Code → Review → Commit
```

### Выбор workflow по типу задачи

| Тип задачи | Workflow | Документ |
|------------|----------|----------|
| Новая функциональность | Полный 7-фазный | [feature-development.md](.claude/workflows/feature-development.md) |
| Исправление ошибки | Упрощённый 5-шаговый | [small-changes.md](.claude/workflows/small-changes.md) |
| Рефакторинг | Гибридный | [small-changes.md](.claude/workflows/small-changes.md) |
| Интеграция | Полный с прототипом | [feature-development.md](.claude/workflows/feature-development.md) |

### Think-команды для сложных задач

Используйте явные указания для глубины анализа:

| Команда | Когда использовать |
|---------|-------------------|
| `think` | Стандартный анализ |
| `think hard` | Сложная логика, множество зависимостей |
| `think harder` | Архитектурные решения |
| `ultrathink` | Критически важные изменения |

---

## Структура проекта

### Обязательные файлы

```
project-root/
├── CLAUDE.md                    # Главная конфигурация (этот файл адаптируется)
├── .claude/
│   ├── rules/                   # Правила по категориям
│   │   ├── 1c-code.md          # Стандарты кода 1С
│   │   ├── comments.md         # Политика комментариев
│   │   ├── git-workflow.md     # Работа с git
│   │   ├── versioning.md       # Версионирование
│   │   ├── task-management.md  # Управление задачами
│   │   ├── mcp-integration.md  # MCP серверы
│   │   └── testing.md          # Тестирование
│   ├── workflows/               # Процессы разработки
│   │   ├── feature-development.md
│   │   └── small-changes.md
│   ├── agents/                  # Описания AI-агентов
│   │   ├── explorer.md
│   │   ├── architect.md
│   │   ├── writer.md
│   │   └── reviewer.md
│   ├── memory-bank/             # Контекст проекта
│   │   ├── projectbrief.md
│   │   ├── productContext.md
│   │   ├── systemPatterns.md
│   │   ├── techContext.md
│   │   ├── activeContext.md
│   │   └── progress.md
│   └── commands/                # Команды
│       ├── start-session.md    # Начало сессии
│       ├── new-task.md         # Регистрация задачи
│       ├── finish-task.md      # Завершение задачи
│       └── update-knowledge.md # Обновление базы знаний
└── TASK.md                      # Текущая задача (опционально)
```

### Адаптация под проект

При создании нового проекта:

1. Скопировать структуру `.claude/` из шаблона
2. Адаптировать `CLAUDE.md` под специфику проекта
3. Заполнить `memory-bank/` начальным контекстом
4. Настроить интеграцию с task-трекером (если есть)
5. Указать специфичные MCP-серверы

---

## Memory Bank — Сохранение контекста

### Назначение файлов

| Файл | Назначение | Частота обновления |
|------|------------|-------------------|
| `projectbrief.md` | Общее описание и цели проекта | При изменении scope |
| `productContext.md` | Бизнес-контекст, пользователи, требования | При изменении требований |
| `systemPatterns.md` | Архитектурные решения и их обоснование | При архитектурных изменениях |
| `techContext.md` | Технический стек, версии, зависимости | При изменении стека |
| `activeContext.md` | Текущий фокус и активные задачи | В начале/конце каждой сессии |
| `progress.md` | История изменений с датами | После каждой значимой задачи |

### Правила работы с Memory Bank

**В начале сессии:**
1. Прочитать `activeContext.md` — понять текущее состояние
2. Прочитать `progress.md` — понять историю
3. При необходимости — другие файлы для контекста

**Во время работы:**
- Обновлять `activeContext.md` при смене фокуса

**После завершения задачи:**
- Добавить запись в `progress.md` с датой
- Обновить `activeContext.md`
- При архитектурных решениях — обновить `systemPatterns.md`

---

## Разделение ответственности

### Критическое правило

| Кто | Что делает |
|-----|------------|
| **Пользователь (разработчик)** | Создаёт объекты метаданных в Конфигураторе/EDT |
| **Claude Code** | Пишет код модулей (.bsl файлы) |

**Claude Code НЕ может:**
- Создавать справочники, документы, регистры
- Добавлять реквизиты, табличные части
- Создавать формы, команды, подписки
- Изменять структуру конфигурации

**Claude Code МОЖЕТ:**
- Писать код общих модулей
- Писать код модулей объектов
- Писать код модулей форм
- Писать код модулей команд
- Формировать запросы

---

## Ключевые правила кодирования

Полные правила: [.claude/rules/1c-code.md](.claude/rules/1c-code.md)

### Краткая сводка

| Аспект | Правило |
|--------|---------|
| **Язык кода** | Русский (кириллица) |
| **Кодировка** | UTF-8 with BOM |
| **Перевод строк** | CRLF |
| **Отступы** | Табуляция (4 символа) |
| **Длина строки** | Максимум 120 символов |
| **Буква "ё"** | Не использовать |
| **Именование** | PascalCase, говорящие имена |
| **Префикс расширения** | Определяется проектом (например: `бэкс`, `бтех`) |

### Обязательная проверка перед написанием кода

1. **Проверить встроенные функции** через MCP `docsearch`
2. **Проверить функции БСП** через MCP `ssl_search`
3. **Найти существующие шаблоны** через MCP `templatesearch`
4. **Проверить синтаксис** через MCP `syntaxcheck`

---

## MCP серверы для 1С

Полная документация: [.claude/rules/mcp-integration.md](.claude/rules/mcp-integration.md)

### Стандартный набор

| Сервер | Инструмент | Назначение | Язык запроса |
|--------|------------|-----------|--------------|
| Platform Docs | `docsearch` | Документация платформы 1С | English |
| SSL Docs | `ssl_search` | Библиотека БСП | Русский |
| Code Templates | `templatesearch` | Готовые шаблоны кода | English |
| Metadata | `search_metadata` | Метаданные конфигурации | Русский |
| Syntax Check | `syntaxcheck` | Проверка синтаксиса | — |

### Правило использования

**ВСЕГДА** проверять через MCP перед написанием нового кода:
- Существует ли нужный метод в платформе?
- Есть ли готовая функция в БСП?
- Есть ли шаблон для типовой операции?

---

## Работа с Git

Полные правила: [.claude/rules/git-workflow.md](.claude/rules/git-workflow.md)

### Структура веток

```
main                    # Стабильная версия
├── develop             # Ветка разработки
├── feature/TASK-ID-*   # Feature-ветки
├── bugfix/TASK-ID-*    # Исправления
└── hotfix/*            # Срочные исправления
```

### Формат коммитов

```
<тип>(<scope>): <краткое описание>

<подробное описание если нужно>

Refs: TASK-123
```

**Типы:**
- `feat` — новая функциональность
- `fix` — исправление ошибки
- `refactor` — рефакторинг
- `docs` — документация
- `test` — тесты

---

## Управление задачами

Полные правила: [.claude/rules/task-management.md](.claude/rules/task-management.md)

### Встроенный TodoWrite

Использовать для:
- Планирования сложных задач (3+ шагов)
- Отслеживания прогресса
- Декомпозиции большого функционала

### Интеграция с внешними трекерами

Поддерживаемые системы:
- **Yougile** — через CLI утилиту
- **Jira** — через API
- **GitHub Issues** — через gh CLI

---

## Версионирование

Полные правила: [.claude/rules/versioning.md](.claude/rules/versioning.md)

### Формат версии

```
MAJOR.MINOR.PATCH[.BUILD]
```

| Компонент | Когда увеличивать |
|-----------|-------------------|
| MAJOR | Несовместимые изменения |
| MINOR | Новая функциональность (совместимая) |
| PATCH | Исправления ошибок |
| BUILD | Автоматически при сборке (опционально) |

---

## Тестирование

Полные правила: [.claude/rules/testing.md](.claude/rules/testing.md)

### Уровни тестирования

1. **Проверка синтаксиса** — через MCP `syntaxcheck`
2. **Unit-тесты** — xUnitFor1C (где применимо)
3. **Интеграционные тесты** — HTTP-клиент (Postman, curl)
4. **Ручное тестирование** — в тестовой базе

---

## Команды

### Основные команды

| Команда | Назначение | Файл |
|---------|-----------|------|
| `/start` | Начало новой сессии | [start-session.md](.claude/commands/start-session.md) |
| `/new-task` | Регистрация новой задачи | [new-task.md](.claude/commands/new-task.md) |
| `/finish` | Завершение задачи | [finish-task.md](.claude/commands/finish-task.md) |
| `/update-knowledge` | Обновление базы знаний | [update-knowledge.md](.claude/commands/update-knowledge.md) |

### Начало сессии (`/start`)

Выполняется в начале каждой рабочей сессии:

1. Очистка контекста (`/clear`)
2. Загрузка Memory Bank (CLAUDE.md, activeContext.md, progress.md)
3. Синхронизация с трекером задач (если настроен)
4. Проверка состояния git
5. Вывод сводки и готовность к работе

**Пример:**
```
/start
```

### Регистрация задачи (`/new-task`)

Формализация новой задачи с автоматическим выбором workflow:

1. Сбор информации (описание, тип, приоритет)
2. Классификация и выбор workflow
3. Генерация ID задачи (FEAT-1, FIX-23, etc.)
4. Создание TodoWrite
5. Обновление activeContext.md

**Пример:**
```
/new-task Добавить endpoint получения истории статусов заказа
```

### Завершение задачи (`/finish`)

Корректное завершение с обновлением всех артефактов:

1. Проверка завершённости (чек-лист)
2. Обновление TodoWrite и трекера
3. Создание коммита
4. Обновление Memory Bank (activeContext.md, progress.md)

**Пример:**
```
/finish FEAT-123
```

---

## Ссылки на детальные документы

### Правила

| Документ | Описание |
|----------|----------|
| [1c-code.md](.claude/rules/1c-code.md) | Полные правила кодирования |
| [comments.md](.claude/rules/comments.md) | Политика комментариев |
| [git-workflow.md](.claude/rules/git-workflow.md) | Работа с Git |
| [versioning.md](.claude/rules/versioning.md) | Версионирование |
| [task-management.md](.claude/rules/task-management.md) | Управление задачами |
| [mcp-integration.md](.claude/rules/mcp-integration.md) | MCP серверы |
| [testing.md](.claude/rules/testing.md) | Тестирование |

### Workflows

| Документ | Описание |
|----------|----------|
| [feature-development.md](.claude/workflows/feature-development.md) | 7-фазный workflow для фич |
| [small-changes.md](.claude/workflows/small-changes.md) | 5-шаговый workflow для доработок |

### Агенты

| Документ | Описание |
|----------|----------|
| [explorer.md](.claude/agents/explorer.md) | Исследователь кодовой базы |
| [architect.md](.claude/agents/architect.md) | Архитектор решений |
| [writer.md](.claude/agents/writer.md) | Разработчик кода |
| [reviewer.md](.claude/agents/reviewer.md) | Рецензент кода |

### Команды

| Документ | Описание |
|----------|----------|
| [start-session.md](.claude/commands/start-session.md) | Начало сессии |
| [new-task.md](.claude/commands/new-task.md) | Регистрация задачи |
| [finish-task.md](.claude/commands/finish-task.md) | Завершение задачи |
| [update-knowledge.md](.claude/commands/update-knowledge.md) | Обновление знаний |

---

## Быстрый старт

### Новый проект

1. Скопировать структуру `.claude/` из шаблона
2. Адаптировать `CLAUDE.md` под проект:
   - Указать название и версию
   - Указать префикс расширения
   - Настроить MCP серверы
3. Заполнить `memory-bank/projectbrief.md`
4. Заполнить `memory-bank/techContext.md`
5. Выполнить команду `/start`

### Новая сессия

```
/start
```

Или развёрнуто:
```
Выполни команду начала сессии из .claude/commands/start-session.md
```

### Новая задача

```
/new-task [описание задачи]
```

Или развёрнуто:
```
Новая задача: [описание]
Тип: FEAT
```

### Завершение задачи

```
/finish [ID]
```

Или развёрнуто:
```
Задача FEAT-123 выполнена, завершаю.
```

---

## Адаптация под конкретный проект

При использовании этих правил в реальном проекте, добавьте в начало CLAUDE.md:

```markdown
## Проект: [Название]

| Параметр | Значение |
|----------|----------|
| Версия | X.Y.Z |
| Префикс | [префикс] |
| Конфигурация | [УТ/ERP/БП и версия] |
| Платформа | 8.3.XX |
| БСП | 3.1.XX |

## Специфика проекта

[Описание особенностей данного проекта]
```
