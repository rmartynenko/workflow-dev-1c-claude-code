# Правила написания кода 1С

> Применяется к: `**/*.bsl`, `**/*.os`

## Язык и кодировка

| Параметр | Значение |
|----------|----------|
| Язык кода | Русский (кириллица) |
| Кодировка файлов | UTF-8 with BOM для .bsl |
| Перевод строк | CRLF (Windows/1C стандарт) |
| Буква "ё" | НЕ использовать в коде |

**Исключения для английского:**
- Имена веб-сервисов и их методов
- Параметры HTTP-запросов
- Поля JSON-структур для внешних API

---

## Форматирование

### Отступы и ширина

| Параметр | Значение |
|----------|----------|
| Отступ | Табуляция (НЕ пробелы) |
| Размер табуляции | 4 символа |
| Максимальная длина строки | 120 символов |

### Удаление мёртвого кода

**ОБЯЗАТЕЛЬНО удалять:**
- Неиспользуемые процедуры и функции
- Закомментированный код
- TODO без ссылки на задачу в трекере
- Пустые обработчики событий

---

## Именование

### Переменные (PascalCase)

```bsl
// ПРАВИЛЬНО
МассивРеквизитов
СоответствиеВидовИмен
ДиалогРаботыСКаталогом
НоваяСтрока
ТекущийЭлемент

// НЕПРАВИЛЬНО - сокращения
масРекв
соотвВидИмя
новСтр

// НЕПРАВИЛЬНО - венгерская нотация
МассивКонтрагентов  // → Контрагенты
СписокДокументов    // → Документы

// НЕПРАВИЛЬНО - подчёркивание в начале
_ИмяПеременной
```

### Булевы переменные

Имя должно отражать состояние `Истина`:

```bsl
// ПРАВИЛЬНО
ЕстьОшибки
ЭтоНовый
ДокументПроведен
РазрешеноРедактирование

// НЕПРАВИЛЬНО - отрицание в имени
НетОшибок           // → ЕстьОшибки
НеПроведен          // → Проведен
```

### Процедуры и функции

| Назначение | Паттерн | Пример |
|------------|---------|--------|
| Возвращает описание | Существительное | `ПолноеИмя()` |
| Создаёт новый объект | Префикс "Новый" | `НовоеПолеФормы()` |
| Проверяет условие | "Это" или причастие | `ЭтоВнешняяЗадача()`, `ДокументПроведен()` |
| Выполняет действие | Глагол в инфинитиве | `ВыбратьДанныеПоПравилу()` |
| Получает данные | Префикс "Получить" | `ПолучитьДанныеЗаказа()` |
| Устанавливает значение | Префикс "Установить" | `УстановитьСтатус()` |

### Префикс расширения

**Все экспортные функции расширения** используют префикс проекта:

```bsl
// Примеры префиксов по проектам:
// бэкс - business export
// бтех - BisOnTech
// инт  - integration

// Экспортная функция - с префиксом
Функция бэксПолучитьДанныеЗаказа(ИдентификаторЗаказа) Экспорт
    // ...
КонецФункции

// Внутренняя функция - без префикса
Функция ПреобразоватьВJSON(Данные)
    // ...
КонецФункции
```

**Определение префикса проекта:**
- Указывается в `CLAUDE.md` проекта
- Используется для всех модулей расширения
- Обеспечивает уникальность имён

---

## Структура модулей

### Общие модули

```bsl
#Область ПрограммныйИнтерфейс

// Экспортные функции для внешнего использования
// (публичное API расширения)

Функция ПрефиксПолучитьДанные() Экспорт
    // ...
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Экспортные процедуры для использования другими модулями расширения
// (внутреннее API)

Функция ПрефиксВнутренняяФункция() Экспорт
    // ...
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Внутренняя реализация (не экспортные)

Функция ВспомогательнаяФункция()
    // ...
КонецФункции

#КонецОбласти
```

### Модули объектов (документы, справочники)

```bsl
#Область ОписаниеПеременных

Перем МодульнаяПеременная;

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ)
    // ...
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
    // ...
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Внутренняя реализация

#КонецОбласти

#Область Инициализация

// Инициализация модульных переменных

#КонецОбласти
```

### Модули форм

```bsl
#Область ОписаниеПеременных

// Клиентские переменные формы

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // ...
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
    // ...
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПолеПриИзменении(Элемент)
    // ...
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормы

&НаКлиенте
Процедура ТаблицаПриАктивизацииСтроки(Элемент)
    // ...
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаВыполнить(Команда)
    // ...
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Разделение по контексту выполнения

&НаКлиенте
Функция КлиентскаяФункция()
    // ...
КонецФункции

&НаСервере
Функция СерверныеВычисления()
    // ...
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьДанныеБезКонтекста()
    // ...
КонецФункции

#КонецОбласти
```

---

## Контекст выполнения (директивы компиляции)

| Операция | Директива | Причина |
|----------|-----------|---------|
| Массовые операции с данными | `&НаСервереБезКонтекста` | Производительность |
| Чтение данных для отображения | `&НаСервереБезКонтекста` | Минимизация передачи |
| Изменение данных формы | `&НаСервере` | Нужен контекст формы |
| Интерактивные действия | `&НаКлиенте` | Отзывчивость UI |
| Асинхронные операции | `&НаКлиенте` с `Асинх` | Неблокирующий UI |

### Правило предпочтения

```
&НаСервереБезКонтекста > &НаСервере
```

Используйте `&НаСервере` только когда действительно нужен контекст формы.

---

## Обработка ошибок

### Принципы

1. **Избегать** `Попытка...Исключение` для стандартных операций с БД
2. **Использовать** транзакции с предварительной проверкой условий
3. **Логировать** только значимые ошибки
4. **Не подавлять** исключения без обработки

### Паттерн для API / интеграций

```bsl
Функция ВыполнитьОперацию(Параметры)

    Результат = Новый Структура("Успех, Данные, Ошибка", Ложь, Неопределено, "");

    // 1. Валидация БЕЗ исключений
    ОшибкаВалидации = ПроверитьПараметры(Параметры);
    Если ЗначениеЗаполнено(ОшибкаВалидации) Тогда
        Результат.Ошибка = ОшибкаВалидации;
        Возврат Результат;
    КонецЕсли;

    // 2. Бизнес-логика с транзакцией
    НачатьТранзакцию();
    Попытка

        // Операции с данными
        // ...

        ЗафиксироватьТранзакцию();
        Результат.Успех = Истина;
        Результат.Данные = ПолученныеДанные;

    Исключение
        ОтменитьТранзакцию();

        ИнформацияОбОшибке = ИнформацияОбОшибке();
        Результат.Ошибка = КраткоеПредставлениеОшибки(ИнформацияОбОшибке);

        // Логирование для анализа
        ЗаписьЖурналаРегистрации(
            "ИмяМодуля.ВыполнитьОперацию",
            УровеньЖурналаРегистрации.Ошибка,
            ,
            ,
            ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));

    КонецПопытки;

    Возврат Результат;

КонецФункции
```

### Паттерн для транзакций

```bsl
// ПРАВИЛЬНО - проверка перед действием
Если Документ.Проведен Тогда
    Возврат; // или сообщение об ошибке
КонецЕсли;

НачатьТранзакцию();
Попытка
    Документ.Записать(РежимЗаписиДокумента.Проведение);
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
    ВызватьИсключение;
КонецПопытки;

// НЕПРАВИЛЬНО - исключение для контроля потока
Попытка
    Документ.Записать(РежимЗаписиДокумента.Проведение);
Исключение
    // Подавление ошибки
КонецПопытки;
```

---

## Работа с данными

### Получение реквизитов ссылок

```bsl
// НЕПРАВИЛЬНО - обращение через точку
ИмяКонтрагента = Контрагент.Наименование;

// ПРАВИЛЬНО - через функцию БСП
ИмяКонтрагента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
    Контрагент,
    "Наименование");

// ПРАВИЛЬНО - получение нескольких реквизитов
РеквизитыКонтрагента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
    Контрагент,
    "Наименование, ИНН, КПП");
```

### Работа с запросами

```bsl
// КРИТИЧНО: НЕ выполнять запросы в циклах!

// НЕПРАВИЛЬНО
Для Каждого Элемент Из Коллекция Цикл
    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ ... ГДЕ Ссылка = &Ссылка";
    Запрос.УстановитьПараметр("Ссылка", Элемент.Ссылка);
    Результат = Запрос.Выполнить(); // N запросов!
КонецЦикла;

// ПРАВИЛЬНО - пакетный запрос
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ ... ГДЕ Ссылка В (&СписокСсылок)";
Запрос.УстановитьПараметр("СписокСсылок", СписокСсылок);
Результат = Запрос.Выполнить(); // 1 запрос
```

### Псевдонимы в запросах

```bsl
// ПРАВИЛЬНО - явные псевдонимы
Запрос.Текст = "
    |ВЫБРАТЬ
    |   Товары.Ссылка КАК Товар,
    |   Товары.Наименование КАК НаименованиеТовара,
    |   Цены.Цена КАК ТекущаяЦена
    |ИЗ
    |   Справочник.Номенклатура КАК Товары
    |   ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры КАК Цены
    |   ПО Товары.Ссылка = Цены.Номенклатура";
```

### Кеширование в циклах

```bsl
// Кеширование через Соответствие
КешКонтрагентов = Новый Соответствие;

Для Каждого Строка Из ТаблицаДанных Цикл

    ДанныеКонтрагента = КешКонтрагентов.Получить(Строка.Контрагент);

    Если ДанныеКонтрагента = Неопределено Тогда
        ДанныеКонтрагента = ПолучитьДанныеКонтрагента(Строка.Контрагент);
        КешКонтрагентов.Вставить(Строка.Контрагент, ДанныеКонтрагента);
    КонецЕсли;

    // Использование ДанныеКонтрагента

КонецЦикла;
```

---

## Работа с JSON

### Запись JSON

```bsl
ЗаписьJSON = Новый ЗаписьJSON;

// Настройки форматирования
ПараметрыЗаписи = Новый ПараметрыЗаписиJSON(
    ПереносСтрокJSON.Unix,       // Unix line endings (\n)
    Символы.Таб);                // Отступ табуляцией

ЗаписьJSON.УстановитьСтроку(ПараметрыЗаписи);

// Сериализация
ЗаписатьJSON(ЗаписьJSON, ДанныеДляЗаписи);

СтрокаJSON = ЗаписьJSON.Закрыть();
```

### Чтение JSON

```bsl
ЧтениеJSON = Новый ЧтениеJSON;
ЧтениеJSON.УстановитьСтроку(СтрокаJSON);

// Чтение в Соответствие (не в Структуру!)
// Истина = ключи как строки, произвольный регистр
Данные = ПрочитатьJSON(ЧтениеJSON, Истина);

ЧтениеJSON.Закрыть();
```

---

## Асинхронность

### Предпочтение Асинх над ОписаниеОповещения

```bsl
// УСТАРЕВШИЙ подход (до 8.3.18)
ОписаниеОповещения = Новый ОписаниеОповещения(
    "ПослеВыбораФайла",
    ЭтотОбъект);
НачатьПомещениеФайла(ОписаниеОповещения, , , Истина);

// СОВРЕМЕННЫЙ подход (8.3.18+)
&НаКлиенте
Асинх Функция ВыбратьИЗагрузитьФайл()

    Результат = Ждать ПоместитьФайлНаСерверАсинх(, , , Истина);

    Если Результат.Помещен Тогда
        Ждать ОбработатьФайлНаСервереАсинх(Результат.Адрес);
    КонецЕсли;

КонецФункции
```

---

## Запрещённые практики

| Практика | Причина | Альтернатива |
|----------|---------|--------------|
| `Сообщить()` | Устаревший метод | `ОбщегоНазначения.СообщитьПользователю()` |
| Венгерская нотация | Избыточность | Говорящие имена |
| Глобальные имена как переменные | Конфликты | Другие имена |
| Запросы в циклах | Производительность | Пакетные запросы |
| Пустые исключения | Скрытие ошибок | Логирование + обработка |
| Тернарные операторы | Читаемость | `Если...Тогда...Иначе` |

---

## Проверка кода перед написанием

### Обязательный чек-лист

1. **Проверить в MCP `docsearch`:**
   - Существует ли нужный метод в платформе?
   - Правильный ли синтаксис?

2. **Проверить в MCP `ssl_search`:**
   - Есть ли готовая функция в БСП?
   - Как правильно её вызвать?

3. **Проверить в MCP `templatesearch`:**
   - Есть ли шаблон для типовой операции?

4. **Проверить в MCP `syntaxcheck`:**
   - Нет ли синтаксических ошибок?

5. **Проверить в существующем коде:**
   - Как решены аналогичные задачи?
   - Какие паттерны используются?

---

## Соответствие bsl-language-server

Код должен проходить проверку `bsl-language-server` без ошибок и предупреждений уровня Error.

Допустимые исключения должны быть задокументированы в комментарии с обоснованием.
