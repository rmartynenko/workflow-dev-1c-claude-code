# Правила тестирования

## Уровни тестирования

```
┌─────────────────────────────────────┐
│         Manual Testing              │  ← Проверка в тестовой базе
├─────────────────────────────────────┤
│       Integration Tests             │  ← HTTP-клиент, API тесты
├─────────────────────────────────────┤
│          Unit Tests                 │  ← xUnitFor1C
├─────────────────────────────────────┤
│        Syntax Check                 │  ← MCP syntaxcheck
└─────────────────────────────────────┘
```

---

## Уровень 1: Проверка синтаксиса

### Инструмент

MCP сервер `syntaxcheck`

### Когда выполнять

- После каждого изменения кода
- Перед коммитом
- При code review

### Правила

1. **Максимум 3 итерации** проверки подряд
2. После 3 неудач — анализ и изменение подхода
3. Все ошибки должны быть исправлены
4. Предупреждения — по ситуации

### Пример workflow

```
1. Написать код
2. syntaxcheck → 2 ошибки
3. Исправить ошибки
4. syntaxcheck → 0 ошибок ✓
5. Коммит
```

---

## Уровень 2: Unit-тесты

### Фреймворк

**xUnitFor1C** — фреймворк модульного тестирования для 1С

### Структура тестов

```
Tests/
├── CommonModules/
│   └── ТестыПрефиксМодуль/
│       └── Module.bsl
└── DataProcessors/
    └── ТестовыйНабор/
        └── Module.bsl
```

### Именование тестов

```bsl
// Формат: Тест_<ЧтоТестируем>_<Условие>_<ОжидаемыйРезультат>

Процедура Тест_ПолучитьСтатусЗаказа_СуществующийЗаказ_ВозвращаетСтатус() Экспорт
    // ...
КонецПроцедуры

Процедура Тест_ПолучитьСтатусЗаказа_НесуществующийЗаказ_ВозвращаетНеопределено() Экспорт
    // ...
КонецПроцедуры
```

### Структура теста (AAA)

```bsl
Процедура Тест_РасчетСкидки_VIPКлиент_Скидка10Процентов() Экспорт

    // Arrange (Подготовка)
    Клиент = СоздатьТестовогоКлиента(Истина); // VIP = Истина
    Сумма = 1000;

    // Act (Действие)
    СуммаСоСкидкой = ПрефиксРассчитатьСуммуСоСкидкой(Клиент, Сумма);

    // Assert (Проверка)
    ОжидаемаяСумма = 900; // 10% скидка
    юТест.ПроверитьРавенство(СуммаСоСкидкой, ОжидаемаяСумма,
        "Сумма со скидкой для VIP клиента");

КонецПроцедуры
```

### Типы проверок

```bsl
// Равенство
юТест.ПроверитьРавенство(Фактическое, Ожидаемое, Сообщение);

// Неравенство
юТест.ПроверитьНеравенство(Значение1, Значение2, Сообщение);

// Истина/Ложь
юТест.ПроверитьИстину(Условие, Сообщение);
юТест.ПроверитьЛожь(Условие, Сообщение);

// Заполненность
юТест.ПроверитьЗаполненность(Значение, Сообщение);
юТест.ПроверитьНезаполненность(Значение, Сообщение);

// Тип
юТест.ПроверитьТип(Значение, "Структура", Сообщение);

// Исключение
юТест.ПроверитьВызовИсключения(Объект, "МетодСОшибкой", Параметры, Сообщение);
```

### Что тестировать

| Тестировать | Не тестировать |
|-------------|----------------|
| Бизнес-логика | Платформенные методы |
| Валидация данных | Очевидный код |
| Расчёты и алгоритмы | UI (формы) |
| Преобразования данных | Прямые запросы к БД |
| Граничные случаи | Внешние сервисы (mock) |

---

## Уровень 3: Интеграционные тесты

### Инструменты

- **Postman** — GUI для тестирования API
- **curl** — командная строка
- **HTTPie** — удобный HTTP-клиент
- **Newman** — CLI для Postman коллекций

### Структура тестов API

```
tests/
├── collections/
│   └── api-tests.postman_collection.json
├── environments/
│   ├── dev.postman_environment.json
│   └── test.postman_environment.json
└── scripts/
    └── run-tests.sh
```

### Пример теста Postman

```javascript
// Pre-request Script
pm.environment.set("timestamp", Date.now());

// Tests
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response has data", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('data');
});

pm.test("Response time is acceptable", function () {
    pm.expect(pm.response.responseTime).to.be.below(500);
});
```

### curl примеры

```bash
# GET запрос
curl -X GET \
  "http://server/hs/api/v1/orders/123" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"

# POST запрос
curl -X POST \
  "http://server/hs/api/v1/orders" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"customer_id": "uuid", "items": [...]}'
```

### Что тестировать

| Аспект | Проверки |
|--------|----------|
| Успешные сценарии | 200/201, корректные данные |
| Ошибки валидации | 400, понятные сообщения |
| Авторизация | 401/403, проверка прав |
| Не найдено | 404, корректный ответ |
| Серверные ошибки | 500, не раскрытие деталей |
| Производительность | Время ответа < SLA |

---

## Уровень 4: Ручное тестирование

### Тестовая среда

| Параметр | Значение |
|----------|----------|
| Платформа | Соответствует production |
| Конфигурация | Копия с тестовыми данными |
| Данные | Анонимизированные или сгенерированные |

### Чек-лист ручного тестирования

```markdown
## Тестирование функциональности: [Название]

### Предусловия
- [ ] Тестовая база развёрнута
- [ ] Расширение установлено
- [ ] Тестовые данные загружены

### Основные сценарии
- [ ] Сценарий 1: [Описание]
  - Шаги: ...
  - Ожидаемый результат: ...
  - Фактический результат: ...

### Граничные случаи
- [ ] Пустые данные
- [ ] Максимальные значения
- [ ] Специальные символы

### Негативные сценарии
- [ ] Неверные параметры
- [ ] Недостаточно прав
- [ ] Конкурентный доступ

### Результат
- [ ] Пройдено
- [ ] Не пройдено (описание проблемы)
```

---

## Test Data Management

### Принципы

1. **Изоляция** — тесты не влияют друг на друга
2. **Повторяемость** — одинаковый результат при повторном запуске
3. **Независимость** — тесты работают в любом порядке

### Генерация тестовых данных

```bsl
Функция СоздатьТестовогоКонтрагента(ЭтоVIP = Ложь)

    НовыйКонтрагент = Справочники.Контрагенты.СоздатьЭлемент();
    НовыйКонтрагент.Наименование = "Тест_" + Строка(Новый УникальныйИдентификатор);
    НовыйКонтрагент.VIP = ЭтоVIP;
    НовыйКонтрагент.Записать();

    Возврат НовыйКонтрагент.Ссылка;

КонецФункции
```

### Очистка после тестов

```bsl
Процедура ПослеТеста() Экспорт

    // Удаление тестовых данных
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ Ссылка ИЗ Справочник.Контрагенты
        |ГДЕ Наименование ПОДОБНО ""Тест_%""";

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        Объект = Выборка.Ссылка.ПолучитьОбъект();
        Объект.Удалить();
    КонецЦикла;

КонецПроцедуры
```

---

## CI/CD интеграция

### Pipeline тестирования

```yaml
stages:
  - syntax
  - unit
  - integration
  - manual

syntax_check:
  stage: syntax
  script:
    - # Проверка синтаксиса через bsl-language-server

unit_tests:
  stage: unit
  script:
    - # Запуск xUnitFor1C

integration_tests:
  stage: integration
  script:
    - newman run tests/collections/api-tests.json -e tests/environments/test.json

manual_testing:
  stage: manual
  when: manual
  script:
    - echo "Требуется ручное тестирование"
```

### Критерии прохождения

| Уровень | Критерий |
|---------|----------|
| Syntax | 0 ошибок |
| Unit | 100% тестов пройдено |
| Integration | 100% тестов пройдено |
| Manual | Все сценарии проверены |

---

## Покрытие кода

### Что измерять

- Покрытие строк кода
- Покрытие веток (if/else)
- Покрытие функций

### Целевые показатели

| Компонент | Минимум | Цель |
|-----------|---------|------|
| Бизнес-логика | 80% | 90% |
| Валидация | 90% | 100% |
| Утилиты | 70% | 80% |
| UI код | — | — |

### Исключения из покрытия

- Код форм (UI)
- Сгенерированный код
- Обработчики платформы без логики
- Код для обратной совместимости

---

## Документирование тестов

### Тест-кейсы

```markdown
## TC-001: Создание заказа

**Предусловия:**
- Пользователь авторизован
- Есть доступ к API

**Шаги:**
1. POST /v1/orders с валидными данными
2. Проверить ответ

**Ожидаемый результат:**
- HTTP 201 Created
- Ответ содержит id созданного заказа
- Заказ появился в базе

**Приоритет:** High
**Автоматизация:** Да
```

### Отчёт о тестировании

```markdown
## Отчёт о тестировании v1.2.0

**Дата:** 2026-01-15
**Версия:** 1.2.0
**Тестировщик:** [Имя]

### Сводка

| Уровень | Всего | Пройдено | Провалено | Пропущено |
|---------|-------|----------|-----------|-----------|
| Unit | 45 | 45 | 0 | 0 |
| Integration | 20 | 19 | 1 | 0 |
| Manual | 10 | 10 | 0 | 0 |

### Дефекты
- BUG-123: [Описание] — Critical

### Рекомендация
- [ ] Готово к релизу
- [x] Требуется исправление BUG-123
```
