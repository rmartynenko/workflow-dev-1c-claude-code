# Интеграция MCP серверов

## Обзор

MCP (Model Context Protocol) серверы предоставляют Claude Code доступ к:
- Документации платформы 1С
- Библиотеке стандартных подсистем (БСП/SSL)
- Шаблонам кода
- Метаданным конфигурации
- Проверке синтаксиса

---

## Стандартный набор серверов

### Обязательные серверы

| Сервер | Порт | Инструмент | Назначение |
|--------|------|------------|------------|
| Platform Docs | 8003 | `docsearch` | Документация платформы 1С |
| SSL Docs | 8008 | `ssl_search` | Библиотека БСП |
| Code Templates | 8004 | `templatesearch` | Готовые шаблоны кода |
| Syntax Check | 8002 | `syntaxcheck` | Проверка синтаксиса |

### Опциональные серверы

| Сервер | Порт | Инструмент | Назначение |
|--------|------|------------|------------|
| Metadata | 8006 | `search_metadata` | Метаданные конфигурации |
| Code Check | 8007 | `codecheck` | Расширенная проверка кода |
| Forms | 8011 | `forms_*` | Работа с формами |
| Graph Metadata | 8000 | `cypher_query` | Граф метаданных (Neo4j) |

---

## Конфигурация MCP

### Файл mcp.json

```json
{
  "mcpServers": {
    "1c-docs-mcp": {
      "url": "http://localhost:8003/sse",
      "transport": "sse"
    },
    "1c-ssl-mcp": {
      "url": "http://localhost:8008/sse",
      "transport": "sse"
    },
    "1c-templates-mcp": {
      "url": "http://localhost:8004/sse",
      "transport": "sse"
    },
    "1c-syntax-checker-mcp": {
      "url": "http://localhost:8002/sse",
      "transport": "sse"
    },
    "1c-metadata-mcp": {
      "url": "http://localhost:8006/sse",
      "transport": "sse"
    }
  }
}
```

### Размещение конфигурации

```
%APPDATA%\Claude\claude_desktop_config.json    # Для Claude Desktop
~/.config/claude-code/mcp.json                  # Для Claude Code CLI
./.claude/mcp.json                              # Для проекта (приоритет)
```

---

## Правила использования

### Обязательная проверка перед написанием кода

```
1. docsearch    → Проверить существование метода платформы
2. ssl_search   → Проверить наличие функции в БСП
3. templatesearch → Найти шаблон для типовой операции
4. syntaxcheck  → Проверить написанный код
```

### Язык запросов

| Инструмент | Язык запроса | Примеры |
|------------|--------------|---------|
| `docsearch` | English | `HTTPConnection SendRequest method` |
| `ssl_search` | Русский | `ОбщегоНазначения ЗначениеРеквизитаОбъекта` |
| `templatesearch` | English | `HTTP request JSON response` |
| `search_metadata` | Русский | `Документ ЗаказКлиента реквизиты` |
| `syntaxcheck` | — | Код на проверку |

---

## Детальное описание инструментов

### docsearch — Документация платформы

**Когда использовать:**
- Проверка синтаксиса встроенных функций
- Параметры и типы возврата методов
- Особенности поведения платформы

**Примеры запросов:**
```
HTTPConnection class methods
JSONWriter SetString parameters
Query SetParameter syntax
BackgroundJob Create parameters
```

**Что возвращает:**
- Описание метода/класса
- Сигнатура и параметры
- Примеры использования
- Версия платформы (если актуально)

### ssl_search — Библиотека БСП

**Когда использовать:**
- Поиск готовых функций общего назначения
- Проверка правильности вызова функций БСП
- Понимание паттернов БСП

**Примеры запросов:**
```
ОбщегоНазначения ЗначениеРеквизитаОбъекта
ОбщегоНазначенияКлиентСервер СообщитьПользователю
РаботаСФайлами ПолучитьФайл
СтроковыеФункцииКлиентСервер СтрокаСЧислом
```

**Что возвращает:**
- Полное описание функции
- Параметры с типами
- Возвращаемое значение
- Примеры вызова

### templatesearch — Шаблоны кода

**Когда использовать:**
- Типовые операции (HTTP, JSON, файлы)
- Паттерны обработки ошибок
- Стандартные конструкции

**Примеры запросов:**
```
HTTP POST request with JSON body
Read JSON from file
Transaction with error handling
Background job with callback
Query with temporary table
```

**Что возвращает:**
- Готовый шаблон кода
- Комментарии по использованию
- Варианты адаптации

### syntaxcheck — Проверка синтаксиса

**Когда использовать:**
- После написания нового кода
- При модификации существующего
- При неуверенности в синтаксисе

**Формат запроса:**
```
// Код для проверки
Функция МояФункция(Параметр)
    Возврат Параметр + 1;
КонецФункции
```

**Что возвращает:**
- Список ошибок с позициями
- Предупреждения
- Рекомендации

**Ограничение:** Максимум 3 итерации проверки подряд.

### search_metadata — Метаданные конфигурации

**Когда использовать:**
- Поиск объектов конфигурации
- Структура документов/справочников
- Реквизиты и табличные части

**Примеры запросов:**
```
Документ ЗаказКлиента
Справочник Номенклатура реквизиты
РегистрСведений ЦеныНоменклатуры измерения
```

**Что возвращает:**
- Список реквизитов с типами
- Табличные части
- Связи с другими объектами

---

## Workflow использования MCP

### При написании нового кода

```
1. Задача: "Отправить HTTP POST запрос с JSON"

2. templatesearch: "HTTP POST JSON request 1C"
   → Получить шаблон

3. docsearch: "HTTPConnection class methods"
   → Уточнить параметры

4. Написать код на основе шаблона

5. syntaxcheck: [код]
   → Проверить синтаксис

6. Исправить ошибки если есть

7. syntaxcheck: [исправленный код]
   → Финальная проверка
```

### При использовании функций БСП

```
1. Задача: "Получить значение реквизита ссылки"

2. ssl_search: "ОбщегоНазначения ЗначениеРеквизитаОбъекта"
   → Получить сигнатуру и пример

3. Написать вызов по документации

4. syntaxcheck: [код]
   → Проверить
```

### При работе с метаданными конфигурации

```
1. Задача: "Создать запрос к документу ЗаказКлиента"

2. search_metadata: "Документ ЗаказКлиента"
   → Получить структуру

3. Написать запрос с правильными именами полей

4. syntaxcheck: [код]
   → Проверить
```

---

## Обработка ошибок MCP

### Сервер недоступен

```
1. Проверить запущен ли сервер
2. Проверить порт в конфигурации
3. Использовать альтернативный источник (документация)
4. Сообщить пользователю о проблеме
```

### Пустой результат поиска

```
1. Переформулировать запрос
2. Использовать альтернативный язык (EN/RU)
3. Разбить запрос на части
4. Использовать другой инструмент
```

### Rate limiting

Некоторые серверы имеют ограничения:
- `syntaxcheck`: максимум 3 проверки подряд
- После 3 попыток — сообщить пользователю

---

## Расширенные инструменты

### Работа с формами (1c-forms-mcp)

| Инструмент | Назначение |
|------------|------------|
| `generate_example_form` | Генерация примера формы |
| `get_instructions` | Инструкции по созданию форм |
| `get_xsd_schema` | XSD схема формы |

### Граф метаданных (1c-graph-metadata-mcp)

Для сложных запросов к структуре конфигурации через Cypher:

```cypher
MATCH (d:MetadataObject {name: 'ЗаказКлиента'})-[:HAS_ATTRIBUTE]->(a)
RETURN a.name, a.type
```

---

## Рекомендации

### DO (Делать)

- ✅ Проверять синтаксис после каждого изменения
- ✅ Использовать БСП функции вместо своих реализаций
- ✅ Искать шаблоны перед написанием типового кода
- ✅ Проверять существование методов платформы

### DON'T (Не делать)

- ❌ Писать код без проверки в MCP
- ❌ Игнорировать ошибки syntaxcheck
- ❌ Изобретать велосипед при наличии функции в БСП
- ❌ Продолжать после 3 неудачных проверок

---

## Настройка для нового проекта

### Шаги

1. **Установить MCP серверы** (см. документацию серверов)

2. **Создать конфигурацию**
   ```
   .claude/mcp.json
   ```

3. **Указать в CLAUDE.md** используемые серверы

4. **Проверить доступность**
   ```bash
   curl http://localhost:8003/health
   curl http://localhost:8008/health
   # и т.д.
   ```

5. **Настроить search_metadata** для конкретной конфигурации
