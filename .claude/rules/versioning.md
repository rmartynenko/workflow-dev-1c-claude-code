# Версионирование

## Формат версии

### Стандартный формат

```
MAJOR.MINOR.PATCH[.BUILD]
```

### Примеры

```
1.0.0       # Первый релиз
1.1.0       # Новая функциональность
1.1.1       # Исправление ошибки
2.0.0       # Несовместимые изменения
1.2.3.456   # С номером сборки (опционально)
```

---

## Правила увеличения версии

| Компонент | Когда увеличивать | Сброс |
|-----------|------------------|-------|
| **MAJOR** | Несовместимые изменения API | MINOR и PATCH → 0 |
| **MINOR** | Новая функциональность (совместимая) | PATCH → 0 |
| **PATCH** | Исправления ошибок | — |
| **BUILD** | Автоматически при каждой сборке | — |

---

## Определение несовместимых изменений

### Несовместимые (MAJOR)

- Удаление публичной функции/процедуры
- Изменение сигнатуры (параметры, типы возврата)
- Изменение поведения существующего API
- Удаление/переименование реквизитов документов
- Изменение структуры регистров

### Совместимые (MINOR)

- Добавление новой экспортной функции
- Добавление опционального параметра с значением по умолчанию
- Добавление нового документа/справочника
- Добавление нового реквизита (с обратной совместимостью)
- Расширение enum (перечисления)

### Исправления (PATCH)

- Исправление ошибки без изменения API
- Оптимизация производительности
- Исправление документации
- Незначительные UI-улучшения

---

## Версионирование в 1С

### Расширения конфигурации

Версия указывается в свойствах расширения:

| Свойство | Значение |
|----------|----------|
| Версия | `MAJOR.MINOR.PATCH.BUILD` |
| Режим совместимости | Соответствует основной конфигурации |

### Хранение версии в коде

```bsl
// В общем модуле ПрефиксВерсия

Функция ПрефиксВерсияРасширения() Экспорт
    Возврат "1.2.3";
КонецФункции

Функция ПрефиксДатаВерсии() Экспорт
    Возврат '20260115';
КонецФункции
```

### Проверка совместимости версий

```bsl
Функция ПрефиксПроверитьСовместимостьВерсии(ТребуемаяВерсия) Экспорт

    ТекущаяВерсия = ПрефиксВерсияРасширения();

    ЧастиТекущей = СтрРазделить(ТекущаяВерсия, ".");
    ЧастиТребуемой = СтрРазделить(ТребуемаяВерсия, ".");

    // Сравнение MAJOR
    Если Число(ЧастиТекущей[0]) < Число(ЧастиТребуемой[0]) Тогда
        Возврат Ложь;
    КонецЕсли;

    // MAJOR равны - сравнение MINOR
    Если Число(ЧастиТекущей[0]) = Число(ЧастиТребуемой[0]) Тогда
        Если Число(ЧастиТекущей[1]) < Число(ЧастиТребуемой[1]) Тогда
            Возврат Ложь;
        КонецЕсли;
    КонецЕсли;

    Возврат Истина;

КонецФункции
```

---

## API Версионирование

### URL-версионирование (рекомендуется)

```
/hs/api/v1/orders
/hs/api/v2/orders
```

### Правила поддержки версий API

| Версия | Статус | Срок поддержки |
|--------|--------|----------------|
| v(N) | Current | Активная разработка |
| v(N-1) | Supported | Исправление ошибок, 12 месяцев |
| v(N-2) | Deprecated | Только критические исправления, 6 месяцев |
| v(N-3) | End of Life | Отключение |

### Заголовки версии (альтернатива)

```
X-API-Version: 1
Accept-Version: 1.0
```

---

## Changelog

### Формат CHANGELOG.md

```markdown
# Changelog

Все значимые изменения документируются в этом файле.

## [Unreleased]

### Added
- Новая функция X

### Changed
- Изменено поведение Y

### Fixed
- Исправлена ошибка Z

## [1.2.0] - 2026-01-15

### Added
- Добавлен endpoint /orders/status
- Поддержка batch-операций

### Changed
- Улучшена производительность запросов

### Deprecated
- Метод GetOrderOld() устарел, используйте GetOrder()

### Removed
- Удалён endpoint /legacy/orders (deprecated в 1.0.0)

### Fixed
- Исправлен расчёт скидок для VIP клиентов (#123)

### Security
- Исправлена уязвимость в авторизации (CVE-2026-1234)

## [1.1.0] - 2025-12-01
...
```

### Категории изменений

| Категория | Описание |
|-----------|----------|
| Added | Новая функциональность |
| Changed | Изменения в существующей функциональности |
| Deprecated | Функциональность, которая будет удалена |
| Removed | Удалённая функциональность |
| Fixed | Исправления ошибок |
| Security | Исправления безопасности |

---

## Релизный процесс

### Подготовка релиза

1. **Создать release-ветку**
   ```
   git checkout -b release/1.2.0 develop
   ```

2. **Обновить версию**
   - В свойствах расширения
   - В модуле версии
   - В CHANGELOG.md

3. **Финальное тестирование**
   - Регрессионные тесты
   - Проверка миграций

4. **Merge в main**
   ```
   git checkout main
   git merge --no-ff release/1.2.0
   ```

5. **Создать тег**
   ```
   git tag -a v1.2.0 -m "Release 1.2.0"
   ```

6. **Merge обратно в develop**
   ```
   git checkout develop
   git merge --no-ff release/1.2.0
   ```

### Чек-лист релиза

- [ ] Версия обновлена во всех местах
- [ ] CHANGELOG.md актуален
- [ ] Тесты пройдены
- [ ] Документация обновлена
- [ ] Release notes подготовлены
- [ ] Тег создан
- [ ] Артефакты опубликованы

---

## Пререлизные версии

### Альфа и Бета

```
1.2.0-alpha.1    # Альфа версия, нестабильная
1.2.0-beta.1     # Бета версия, feature-complete
1.2.0-rc.1       # Release candidate
```

### Правила пререлизов

- Альфа: внутреннее тестирование
- Бета: ограниченное внешнее тестирование
- RC: финальное тестирование перед релизом

---

## Автоматизация версионирования

### Скрипт обновления версии

```powershell
# update-version.ps1

param(
    [string]$Version,
    [string]$Part = "patch"  # major, minor, patch
)

# Логика увеличения версии
# Обновление файлов
# Создание коммита
```

### CI/CD интеграция

```yaml
# Пример для GitHub Actions

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build extension
        run: # Сборка расширения с версией ${{ steps.version.outputs.VERSION }}
```
