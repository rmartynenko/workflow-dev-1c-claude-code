# Workflow для небольших изменений

## Обзор

Упрощённый 5-шаговый процесс для быстрых доработок, исправлений и рефакторинга.

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  1. CLARIFY  │ →  │  2. LOCATE   │ →  │  3. CHANGE   │
│  (Уточнить)  │    │  (Найти)     │    │  (Изменить)  │
└──────────────┘    └──────────────┘    └──────────────┘
                                              │
                    ┌──────────────┐    ┌──────────────┐
                    │  5. DELIVER  │ ←  │  4. VERIFY   │
                    │  (Сдать)     │    │  (Проверить) │
                    └──────────────┘    └──────────────┘
```

---

## Когда использовать

| Тип задачи | Примеры |
|------------|---------|
| Bug fix | Исправление ошибки расчёта |
| Small feature | Добавление поля в ответ API |
| Refactoring | Переименование функции |
| Documentation | Обновление комментариев |
| Configuration | Изменение параметров |

### Критерии применимости

- Изменение затрагивает 1-3 файла
- Понятно что нужно сделать
- Нет архитектурных решений
- Не требует исследования кодовой базы

---

## Шаг 1: Clarify Scope (Уточнить scope)

### Действия

1. **Понять задачу:**
   - Что именно нужно изменить?
   - Почему это нужно?
   - Каков ожидаемый результат?

2. **Оценить риски:**
   - Что может сломаться?
   - Нужен ли rollback план?

3. **Подтвердить scope:**
   - Только то, что запрошено
   - Никакого scope creep

### Антипаттерны

❌ Добавление "заодно" улучшений
❌ Рефакторинг соседнего кода
❌ Добавление логирования без запроса
❌ Написание тестов без запроса

### Пример

```
User: Исправь ошибку — скидка VIP клиентов применяется дважды

Claude: Понял. Задача: исправить двойное применение скидки VIP.
Ожидаемый результат: скидка применяется один раз.
Начинаю поиск места с ошибкой.
```

---

## Шаг 2: Locate Insertion Points (Найти точки изменения)

### Действия

1. **Найти точные файлы:**
   - Использовать поиск по ключевым словам
   - Проверить связанные модули

2. **Определить строки:**
   - Точное место изменения
   - Контекст вокруг

3. **Проверить зависимости:**
   - Кто вызывает этот код?
   - На что влияет изменение?

### Инструменты поиска

```bash
# Поиск по ключевому слову
grep -r "СкидкаVIP" --include="*.bsl"

# Поиск вызовов функции
grep -r "РассчитатьСкидку" --include="*.bsl"
```

### Документирование

```
Найдено:
- Файл: ОбщиеМодули/бэксРасчетЦен/Module.bsl
- Строка: 145-160
- Функция: РассчитатьИтоговуюСумму
- Проблема: Вызов ПрименитьСкидкуVIP() в цикле и после цикла
```

---

## Шаг 3: Minimal Changes (Минимальные изменения)

### Принципы

1. **Только необходимое:**
   - Изменить минимум строк
   - Не трогать работающий код рядом

2. **Сохранить стиль:**
   - Следовать существующему форматированию
   - Использовать те же паттерны

3. **Не добавлять:**
   - Логирование (если не просили)
   - Комментарии (если очевидно)
   - Тесты (если не просили)
   - Обработку ошибок (если работало)

### Пример изменения

```bsl
// БЫЛО (ошибка — двойное применение)
Для Каждого Строка Из ТаблицаТоваров Цикл
    ПрименитьСкидкуVIP(Строка);  // Первое применение
КонецЦикла;
ПрименитьСкидкуVIP(ТаблицаТоваров);  // Второе применение ← ОШИБКА

// СТАЛО (исправлено)
Для Каждого Строка Из ТаблицаТоваров Цикл
    ПрименитьСкидкуVIP(Строка);
КонецЦикла;
// Удалён повторный вызов
```

---

## Шаг 4: Double-Check (Проверить)

### Обязательные проверки

1. **Синтаксис:**
   ```
   MCP syntaxcheck → 0 ошибок
   ```

2. **Корректность:**
   - Изменение решает проблему?
   - Не сломалось ли что-то другое?

3. **Влияние:**
   - Проверить вызывающий код
   - Убедиться в отсутствии side effects

### Чек-лист

- [ ] syntaxcheck пройден
- [ ] Изменение минимально
- [ ] Стиль сохранён
- [ ] Зависимости проверены
- [ ] Результат соответствует ожиданиям

---

## Шаг 5: Deliver Clearly (Сдать чётко)

### Сводка изменений

```markdown
## Исправлено: двойное применение скидки VIP

### Изменённые файлы
- ОбщиеМодули/бэксРасчетЦен/Module.bsl (строка 158)

### Что изменено
- Удалён повторный вызов ПрименитьСкидкуVIP() после цикла

### Риски
- Минимальные, изменение локализовано

### Тестирование
- Требуется проверить расчёт суммы для VIP клиента
```

### Формат коммита

```
fix(pricing): исправить двойное применение скидки VIP

Скидка VIP применялась дважды: в цикле по строкам
и повторно ко всей таблице. Удалён повторный вызов.

Refs: TASK-456
```

---

## Специальные случаи

### Рефакторинг

Использовать гибридный подход:

```
1. Анализ сверху-вниз (понять логику)
2. Рефакторинг снизу-вверх (от мелких функций)
3. Интеграция (проверить целостность)
```

### Hotfix в production

```
1. Создать ветку hotfix/описание от main
2. Минимальное исправление
3. Двойная проверка (syntaxcheck + ручная)
4. PR в main И в develop
5. Тег с версией патча
```

### Интеграции

Если нужен прототип:
```
1. Реализовать на Python (быстрее отладка)
2. Протестировать
3. Перенести в 1С по работающему прототипу
```

---

## Антипаттерны

### Что НЕ делать

| Антипаттерн | Почему плохо |
|-------------|--------------|
| "Заодно" улучшения | Scope creep, риски |
| Рефакторинг соседей | Непредсказуемые последствия |
| Добавление комментариев | Шум, не просили |
| "Временное" решение | Станет постоянным |
| Большое изменение | Сложно отлаживать |

### Правильный подход

```
User: Исправь ошибку в расчёте скидки

НЕПРАВИЛЬНО:
- Исправить ошибку
- Отрефакторить функцию
- Добавить логирование
- Написать тесты
- Обновить документацию

ПРАВИЛЬНО:
- Исправить ошибку (1-3 строки)
- Проверить
- Сдать
```

---

## Быстрая справка

### 5 шагов

1. **Clarify** — Что именно делать?
2. **Locate** — Где код?
3. **Change** — Минимальное изменение
4. **Verify** — syntaxcheck + проверка
5. **Deliver** — Сводка + коммит

### Правило минимальности

> Если можно изменить меньше строк — измени меньше.
> Если можно не добавлять — не добавляй.
> Если работает — не трогай.

### Когда переключиться на полный workflow

- Задача оказалась сложнее
- Нужны архитектурные решения
- Требуется исследование кодовой базы
- Изменения затрагивают > 3 файлов

→ Перейти к [feature-development.md](feature-development.md)
