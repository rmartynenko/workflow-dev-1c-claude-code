# Workflow разработки новой функциональности

## Обзор

Семифазный процесс разработки для сложных задач и новой функциональности.

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  1. DISCOVER │ → │ 2. EXPLORE  │ → │ 3. CLARIFY  │ → │ 4. DESIGN   │
│  (Понять)    │    │ (Исследов.) │    │ (Уточнить)  │    │ (Проект.)   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│ 7. SUMMARY  │ ← │  6. REVIEW  │ ← │ 5. IMPLEMENT │ ← ──────┘
│ (Итоги)     │    │ (Проверка)  │    │ (Реализ.)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

---

## Фаза 1: Discovery (Открытие)

### Цель
Понять, что нужно создать.

### Действия

1. **Уточнить требования:**
   - Какую проблему решаем?
   - Кто будет пользоваться?
   - Какой ожидаемый результат?

2. **Выявить ограничения:**
   - Технические ограничения
   - Бизнес-правила
   - Интеграции

3. **Определить scope:**
   - Что входит в задачу?
   - Что НЕ входит?

### Выход

- Чёткое понимание задачи
- Список требований
- Известные ограничения

### Пример диалога

```
Claude: Для реализации endpoint получения статуса заказа, уточните:
1. Какую информацию должен возвращать статус?
2. Нужна ли история изменений статуса?
3. Какие права доступа требуются?

User: Нужен текущий статус и дата последнего изменения.
История не нужна. Доступ по токену с правом orders:read.
```

---

## Фаза 2: Codebase Investigation (Исследование)

### Цель
Понять существующую архитектуру и паттерны.

### Действия

1. **Запустить агентов-исследователей:**
   - Анализ связанных модулей
   - Поиск аналогичных реализаций
   - Изучение зависимостей

2. **Прочитать рекомендованные файлы:**
   - Все файлы, указанные агентами
   - Даже если кажутся неважными

3. **Документировать находки:**
   - Существующие паттерны
   - Точки расширения
   - Потенциальные конфликты

### Использование агентов

```
Запустить параллельно 3 агента 1c-code-explorer:
1. Фокус: существующие endpoint'ы заказов
2. Фокус: модули валидации и авторизации
3. Фокус: структура ответов API
```

### Выход

- Список критических файлов
- Понимание архитектуры
- Выявленные паттерны

---

## Фаза 3: Clarifying Questions (Уточнение)

### Цель
Устранить неопределённости перед проектированием.

### Категории вопросов

| Категория | Примеры |
|-----------|---------|
| Граничные случаи | Что делать если заказ не найден? |
| Обработка ошибок | Какие ошибки возвращать клиенту? |
| Интеграция | С какими модулями взаимодействовать? |
| Производительность | Какой допустимый SLA? |
| Совместимость | Нужна поддержка старых клиентов? |

### Формат вопросов

```markdown
## Уточняющие вопросы

### Граничные случаи
1. Как обрабатывать запрос несуществующего заказа?
   - Вариант A: HTTP 404
   - Вариант B: HTTP 200 с пустым data

### Формат ответа
2. Включать ли в ответ детали заказа или только статус?

### Авторизация
3. Проверять ли принадлежность заказа пользователю?
```

### Выход

- Все вопросы заданы и отвечены
- Нет неопределённостей
- Готовность к проектированию

---

## Фаза 4: Architecture Design (Проектирование)

### Цель
Выбрать оптимальный архитектурный подход.

### Процесс

1. **Рассмотреть 3 подхода:**

   | Подход | Описание |
   |--------|----------|
   | Minimal Changes | Минимальные изменения, быстро |
   | Clean Architecture | Идеальное решение |
   | Pragmatic Balance | Компромисс |

2. **Оценить trade-offs:**
   - Сложность vs Гибкость
   - Скорость vs Качество
   - Текущие затраты vs Будущая поддержка

3. **Выбрать и обосновать**

### Использование агентов

```
Запустить параллельно 3 агента 1c-code-architect:
1. Подход: Minimal Changes
2. Подход: Clean Architecture
3. Подход: Pragmatic Balance
```

### Создание плана

Создать файл `TASK.md` или `plan.md`:

```markdown
# План реализации: Endpoint статуса заказа

## Выбранный подход
Pragmatic Balance

## Обоснование
- Использует существующую инфраструктуру авторизации
- Добавляет минимум новых зависимостей
- Следует паттернам других endpoint'ов

## Компоненты

### 1. Маршрутизация
Файл: ОбщийМодуль.бэксМаршрутизатор
Добавить: обработку GET /v1/orders/{id}/status

### 2. Бизнес-логика
Файл: ОбщийМодуль.бэксОбработкаЗаказов
Добавить: Функция бэксПолучитьСтатусЗаказа(ИдентификаторЗаказа)

### 3. Формат ответа
```json
{
  "data": {
    "status": "processing",
    "status_changed_at": "2026-01-15T10:30:00Z"
  }
}
```

## Последовательность реализации
1. Добавить маршрут
2. Реализовать функцию получения статуса
3. Добавить валидацию
4. Проверить через MCP
5. Протестировать
```

### Выход

- Документированный план
- Выбранный подход с обоснованием
- Последовательность реализации

---

## Фаза 5: Implementation (Реализация)

### Цель
Написать код согласно плану.

### Предварительные условия

**ОБЯЗАТЕЛЬНО получить согласие пользователя на план!**

```
Claude: План готов (см. TASK.md). Начинаю реализацию?

User: Да, начинай.
```

### Процесс

1. **Создать ветку:**
   ```
   feature/TASK-123-order-status-endpoint
   ```

2. **Реализовать по плану:**
   - Следовать последовательности
   - Проверять через MCP после каждого изменения
   - Обновлять TodoWrite

3. **Соблюдать правила кода:**
   - Следовать `rules/1c-code.md`
   - Проверять через `syntaxcheck`

### Использование агента

```
Запустить агент 1c-code-writer:
- Ссылка на план: TASK.md
- Правила: .claude/rules/1c-code.md
```

### Выход

- Написанный код
- Все проверки syntaxcheck пройдены
- Готовность к review

---

## Фаза 6: Quality Assurance (Проверка качества)

### Цель
Обеспечить качество и найти ошибки.

### Процесс

1. **Запустить агентов-рецензентов:**

   | Агент | Фокус |
   |-------|-------|
   | Reviewer 1 | Элегантность, DRY |
   | Reviewer 2 | Баги, корректность |
   | Reviewer 3 | Соответствие правилам проекта |

2. **Обработать результаты:**
   - Критические проблемы → исправить немедленно
   - Важные проблемы → исправить в этой итерации
   - Незначительные → документировать для будущего

3. **Итеративный цикл:**
   ```
   Review → Fix → Review → Fix → ... → Pass
   ```

### Система оценки

| Confidence | Серьёзность | Действие |
|------------|-------------|----------|
| 90+ | Critical | Исправить обязательно |
| 75-89 | Important | Исправить |
| <75 | Low | Игнорировать |

### Выход

- Все критические проблемы исправлены
- Документированы отложенные улучшения
- Код готов к merge

---

## Фаза 7: Summary (Итоги)

### Цель
Завершить и документировать результаты.

### Действия

1. **Обновить документацию:**
   - CHANGELOG.md
   - API документация (если применимо)
   - Memory Bank

2. **Создать коммит:**
   ```
   feat(api): добавить endpoint статуса заказа

   - GET /v1/orders/{id}/status
   - Возвращает текущий статус и дату изменения
   - Проверка прав orders:read

   Refs: TASK-123
   ```

3. **Подготовить отчёт:**

   ```markdown
   ## Итоги реализации

   ### Что сделано
   - Добавлен endpoint GET /v1/orders/{id}/status
   - Реализована функция бэксПолучитьСтатусЗаказа

   ### Изменённые файлы
   - ОбщиеМодули/бэксМаршрутизатор/Module.bsl
   - ОбщиеМодули/бэксОбработкаЗаказов/Module.bsl

   ### Принятые решения
   - HTTP 404 для несуществующего заказа
   - Проверка принадлежности заказа пользователю

   ### Следующие шаги
   - Добавить endpoint истории статусов (TASK-124)
   ```

4. **Обновить Memory Bank:**
   - `activeContext.md` — убрать задачу из активных
   - `progress.md` — добавить запись

### Выход

- Задача закрыта
- Код в репозитории
- Документация обновлена

---

## Быстрая справка

### Когда использовать этот workflow

✅ Новая функциональность
✅ Архитектурные изменения
✅ Интеграции
✅ Задачи > 1 дня работы

### Когда НЕ использовать

❌ Исправление простых багов
❌ Мелкие доработки
❌ Рефакторинг < 3 файлов

→ Для простых задач: [small-changes.md](small-changes.md)

### Контрольные точки

| Фаза | Контрольный вопрос |
|------|-------------------|
| 1 | Понимаю ли я задачу? |
| 2 | Знаю ли я кодовую базу? |
| 3 | Остались ли вопросы? |
| 4 | Есть ли план? |
| 5 | Написан ли код? |
| 6 | Проверено ли качество? |
| 7 | Задокументировано ли? |
